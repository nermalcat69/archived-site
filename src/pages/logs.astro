---
import { getCollection, render } from "astro:content";
import dayjs from "dayjs";
import { RelativeDate } from "src/components/RelativeDate/RelativeDate";
import ProseLayout from "src/layouts/ProseLayout.astro";

const events = await getCollection("now");
events.sort((a, b) => {
  return dayjs(b.data.date).isBefore(dayjs(a.data.date)) ? -1 : 1;
});

const title = "Now";
const description = "How's Arjun's life going?";

// Function to truncate text to approximately 60 words while preserving HTML tags
function truncateToWords(text: string, maxWords: number = 60): { truncated: string; hasMore: boolean } {
  const words = text.trim().split(/\s+/);
  if (words.length <= maxWords) {
    return { truncated: text, hasMore: false };
  }
  
  // Take the first maxWords words
  const truncatedWords = words.slice(0, maxWords);
  let truncated = truncatedWords.join(' ');
  
  // Check if we cut off in the middle of an HTML tag
  const lastTagMatch = truncated.match(/<[^>]*$/);
  if (lastTagMatch) {
    // Remove the incomplete tag
    truncated = truncated.replace(/<[^>]*$/, '');
  }
  
  // Check if we cut off in the middle of a link text
  const lastLinkMatch = truncated.match(/\[([^\]]*)$/);
  if (lastLinkMatch) {
    // Remove the incomplete link
    truncated = truncated.replace(/\[([^\]]*)$/, '');
  }
  
  // Add ellipsis
  truncated += '...';
  
  return { truncated, hasMore: true };
}
---

<ProseLayout title={title} description={description}>
  <ul class="events">
    {
      events.map(async (event) => {
        const { Content } = await render(event);
        // Handle the case where event.body might be undefined
        const contentText = typeof event.body === 'string' ? event.body : '';
        const { truncated, hasMore } = truncateToWords(contentText);

        return (
          <li class="event">
            <div class="dot" aria-hidden />
            <span class="heading">
              <RelativeDate date={event.data.date} client:load />
            </span>
            <div class="line" aria-hidden />
            <div class="content">
              <div class="content-preview" data-event-id={event.id}>
                <div class="preview-text" set:html={truncated} />
                {hasMore && (
                  <button class="read-more-btn" data-event-id={event.id}>
                    Read more
                  </button>
                )}
              </div>
              <div class="content-full" data-event-id={event.id} style="display: none;">
                <Content />
                <button class="read-less-btn" data-event-id={event.id}>
                  Read less
                </button>
              </div>
            </div>
          </li>
        );
      })
    }
    <li class="event">
      <div class="dot" aria-hidden></div>
      <span class="heading">A while ago</span>
      <div class="content">
        <p>
          Worked as a Developer at <a href="https://zerops.io/"
            >Zerops</a
          >, a czech based cloud platform(A better alternative to Fly.io, Render, Railway, Platform.sh, etc).
        </p>
      </div>
    </li>
  </ul>

  <script>
    // Add event listeners when the DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Add click handlers for read more buttons
      document.querySelectorAll('.read-more-btn').forEach(button => {
        button.addEventListener('click', function(this: HTMLButtonElement) {
          const eventId = this.getAttribute('data-event-id');
          if (eventId) {
            toggleContent(eventId);
          }
        });
      });

      // Add click handlers for read less buttons
      document.querySelectorAll('.read-less-btn').forEach(button => {
        button.addEventListener('click', function(this: HTMLButtonElement) {
          const eventId = this.getAttribute('data-event-id');
          if (eventId) {
            toggleContent(eventId);
          }
        });
      });
    });

    function toggleContent(eventId: string) {
      const preview = document.querySelector(`[data-event-id="${eventId}"].content-preview`);
      const full = document.querySelector(`[data-event-id="${eventId}"].content-full`);
      
      if (preview && full && preview instanceof HTMLElement && full instanceof HTMLElement) {
        if (preview.style.display === 'none') {
          preview.style.display = 'block';
          full.style.display = 'none';
        } else {
          preview.style.display = 'none';
          full.style.display = 'block';
        }
      }
    }
  </script>

  <style lang="scss">
    .events {
      list-style: none;
      padding: 0;
      display: flex;
      flex-direction: column;
    }

    .event {
      display: grid;
      grid-template-columns: var(--space-s) 1fr;
      grid-template-areas:
        "dot heading"
        "line content";
      column-gap: var(--space-m);
      justify-content: center;

      &::before {
        content: "";
      }
    }

    .dot {
      grid-area: dot;
      border-radius: var(--radius-full);
      width: var(--space-s);
      height: var(--space-s);
      background-color: var(--gray-7);
      place-self: center center;
    }

    .line {
      grid-area: line;
      width: 2px;
      background-color: var(--gray-7);
      position: absolute;
      top: 0;
      bottom: 0;
      justify-self: center;
    }

    .heading {
      color: var(--gray-11);
      grid-area: heading;
    }

    .content {
      grid-area: content;
    }

    .content-preview, .content-full {
      margin-bottom: var(--space-m);
    }

    .preview-text {
      margin-bottom: var(--space-s);
    }

    .read-more-btn, .read-less-btn {
      background: none;
      border: 1px solid var(--gray-7);
      border-radius: var(--radius-s);
      padding: 0.25em var(--space-xs);
      color: var(--gray-11);
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s ease;

      &:hover {
        background-color: var(--gray-3);
        border-color: var(--gray-8);
      }
    }

    .event:not(:last-child) .content {
      padding-block-end: var(--space-xl);
    }
  </style>
</ProseLayout>
